<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Locais em São Caetano do Sul</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body { font-family: Arial, sans-serif; background-color: #0a043c; color: white; margin: 0; padding: 0; }
        header { display: flex; align-items: center; padding: 15px; background-color: #10102f; position: relative; }
        header img { border-radius: 50%; width: 40px; height: 40px; margin-right: 15px; }
        header input { width: 80%; padding: 10px; border: none; border-radius: 5px; }
        .dropdown { position: absolute; top: 60px; left: 15px; width: 80%; background-color: #333; color: white; border-radius: 5px; max-height: 200px; overflow-y: auto; display: none; }
        .dropdown-item { padding: 10px; cursor: pointer; }
        .dropdown-item:hover { background-color: #555; }
        .container { padding: 15px; }
        .location { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; cursor: pointer; }
        .location img { width: 100%; border-radius: 10px; }
        .location h2 { margin: 10px 0 5px 0; font-size: 18px; }
        .location p { margin: 0; font-size: 14px; color: #bbb; }
        .location .distance { float: right; color: #bbb; }
        .location-details { display: none; margin-top: 10px; }
        .location-details p { color: #bbb; font-size: 14px; margin: 5px 0; }
        .location button { margin-top: 10px; background-color: #ff5733; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; }
        .location button:hover { background-color: #ff2e00; }
        .navbar { position: fixed; bottom: 0; width: 100%; background-color: #10102f; display: flex; justify-content: space-around; padding: 10px 0; }
        .navbar img { width: 25px; }
        #map { height: 500px; width: 100%; } /* Mapa fixo na base do aplicativo */
    </style>
</head>
<body>

<header>
    <img src="profile.png" alt="Profile">
    <input type="text" placeholder="Pesquisar" id="searchInput">
    <div class="dropdown" id="dropdown"></div>
</header>

<div class="container">
    <h3>Lugares próximos de você</h3>
    <div id="locations-list"></div>
</div>

<!-- Contêiner do mapa -->
<div id="map"></div>

<div class="navbar">
    <img src="search_icon.png" alt="Search">
    <img src="favorites_icon.png" alt="Favorites">
    <img src="filter_icon.png" alt="Filter">
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script>
let map, routingControl, userLat, userLon;
const dropdown = document.getElementById('dropdown');
const searchInput = document.getElementById('searchInput');
const locationsList = document.getElementById('locations-list');

// Lista de locais definidos no código
const places = [
    { name: 'Park Shopping São Caetano', lat: -23.62577071710919, lon: -46.58031329507067, img: 'shopping_scs.jpg', description: 'Shopping Center' },
    { name: 'Escola Mario Leandro', lat: -23.691804897254574, lon: -46.43650704828672, img: 'imgborali/escola.jpg', description: 'Escola pública' },
    { name: 'Praça Hiroshiro', lat: -23.692248077859876, lon: -46.43890818397629, img: 'imgborali/praça.jpg', description: 'Praça Pública' },
    { name: 'Parque da Juventude', lat: -23.506975294310987, lon: -46.62042587515163, img: 'imgborali/parque_juventude.jpg', description: 'Parque da Juventude' },
    { name: 'Vivano', lat: -23.616141, lon: -46.565172, img: 'imgborali/vivano.jpg', description: 'Experiência gastronômica' },
    { name: 'Senhor Boteco', lat: -23.616051, lon: -46.570273, img: 'imgborali/senhor_boteco.jpg', description: 'Opção de bar pela cidade' },
    { name: 'USCS Conceição', lat: -23.617801043838988, lon: -46.57895393138371, img: 'imgborali/uscs.jpg', description: 'Universidade' },
    { name: 'Ironberg', lat: -23.623600206635096, lon: -46.57709933812019, img: 'imgborali/ironberg.jpg', description: 'Academia Ironberg' },
];

if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition, showError);
} else {
    alert("Geolocalização não é suportada por este navegador.");
}

function showPosition(position) {
    userLat = position.coords.latitude;
    userLon = position.coords.longitude;
    map = L.map('map').setView([userLat, userLon], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    L.marker([userLat, userLon]).addTo(map)
        .bindPopup('<b>Você está aqui</b>').openPopup();

    renderNearbyLocations();
}

// Renderiza locais próximos (dentro de 2 km)
function renderNearbyLocations() {
    locationsList.innerHTML = ''; // Limpa a lista antes de renderizar
    places.forEach((place, index) => {
        const distance = calculateDistance(userLat, userLon, place.lat, place.lon);
        if (distance <= 2) {
            locationsList.innerHTML += createLocationHTML(place, distance, index);
        }
    });
}

// Cria o HTML para cada local
function createLocationHTML(place, distance, index) {
    return `
        <div class="location" onclick="toggleDetails(${index})">
            <img src="${place.img}" alt="${place.name}">
            <h2>${place.name} <span class="distance">${distance.toFixed(2)} km</span></h2>
            <div class="location-details" id="details-${index}">
                <p>${place.description}</p>
                <button onclick="defineRoute(${userLat}, ${userLon}, ${place.lat}, ${place.lon}); event.stopPropagation();">Definir Rota</button>
            </div>
        </div>
    `;
}

// Função para alternar a exibição da descrição e do botão "Definir Rota"
function toggleDetails(index) {
    const details = document.getElementById(`details-${index}`);
    details.style.display = details.style.display === 'none' || details.style.display === '' ? 'block' : 'none';
}

// Calcula a distância entre dois pontos
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * (Math.PI / 180);
    const dLon = (lon2 - lon1) * (Math.PI / 180);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
              Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

// Função para definir a rota no mapa
function defineRoute(userLat, userLon, destLat, destLon) {
    if (routingControl) {
        map.removeControl(routingControl); // Remove rota anterior, se existir
    }

    routingControl = L.Routing.control({
        waypoints: [
            L.latLng(userLat, userLon),
            L.latLng(destLat, destLon)
        ],
        routeWhileDragging: true,
        lineOptions: {
            styles: [{ color: '#ff5733', opacity: 0.8, weight: 5 }]
        },
        language: 'pt',
        showAlternatives: false,
        addWaypoints: false,
        fitSelectedRoutes: true,
        draggableWaypoints: false,
    }).addTo(map);
}

// Função de pesquisa para filtrar locais
searchInput.addEventListener('input', function() {
    const query = searchInput.value.trim().toLowerCase();
    dropdown.innerHTML = '';  // Limpa o dropdown

    if (query.length > 0) {
        const filteredPlaces = places.filter(place => place.name.toLowerCase().includes(query));
        locationsList.innerHTML = '';

        if (filteredPlaces.length > 0) {
            filteredPlaces.forEach((place, index) => {
                const distance = calculateDistance(userLat, userLon, place.lat, place.lon);
                locationsList.innerHTML += createLocationHTML(place, distance, index);
            });
        }
    } else {
        renderNearbyLocations(); // Volta a exibir locais próximos ao limpar o campo de pesquisa
    }
});

document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
    }
});

function showError(error) {
    switch(error.code) {
        case error.PERMISSION_DENIED:
            alert("Usuário negou a solicitação de geolocalização.");
            break;
        case error.POSITION_UNAVAILABLE:
            alert("As informações de localização não estão disponíveis.");
            break;
        case error.TIMEOUT:
            alert("A solicitação de geolocalização expirou.");
            break;
        case error.UNKNOWN_ERROR:
            alert("Ocorreu um erro desconhecido.");
            break;
    }
}
</script>

</body>
</html>
